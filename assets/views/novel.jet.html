{{- extends "layout/default" }}
{{- block body() }}
<div class="row justify-content-center g-4">

  <div class="col-12 col-md-9">
    <div class="custom-card">
      <div class="card-body bg-charcoal-surface1 rounded-5 p-4">
        <div class="row g-4">
          <div class="col-12 col-md-4">
            <!-- Cover art -->
            <a href="{{ .Novel.CoverURL }}">
              <img src="{{ .Novel.CoverURL }}" alt="{{ .Novel.Title }} cover" class="d-block img-fluid rounded mx-auto" />
            </a>
          </div>
          <div class="col-12 col-md-8 d-flex flex-column">
            <!-- Series name -->
            {{- if .Novel.SeriesNavData }}
              <a href="/novel/series/{{ .Novel.SeriesNavData.SeriesID }}" class="text-decoration-none">
                <h3 class="text-muted mb-2">{{- .Novel.SeriesNavData.Title }} #{{- .Novel.SeriesNavData.Order}}</h3>
              </a>
            {{- end}}

            <!-- Title -->
            <h1 class="mb-2">{{ .Novel.Title }}</h1>

            <!-- Word count and reading time -->
            <p class="text-muted small mb-3">
              <span>{{ .Novel.WordCount }} word(s)</span> &middot; <span>{{ floor: .Novel.ReadingTime / 60 }} mins</span>
            </p>

            <!-- View Pixiv original button -->
            <div class="d-flex">
              <a href="https://pixiv.net/novel/show.php?id={{ .Novel.ID }}" class="custom-btn-secondary bg-charcoal-surface2 btn-sm mb-3">
                <i class="bi bi-box-arrow-up-right me-2"></i>View on pixiv.net
              </a>
            </div>

            <!-- Description -->
            <p class="mb-3">{{ raw: .Novel.Description }}</p>

            <!-- Tags -->
            <div class="d-flex flex-wrap align-items-center mb-3">
              {{- if .Novel.AiType == 2 }}
              <span class="badge bg-warning text-dark me-2 mb-2">AI-generated</span>
              {{- end }}
              {{- range .Novel.Tags.Tags }}
                {* NOTE: early block to catch the R-18 tag *}
                {{- if isEmphasize(.Name) }}
                <span class="badge bg-danger me-2 mb-2">{{ . }}</span>
                {{- end }}
              {{- end }}
              {{- if .Novel.IsOriginal }}
              <span class="badge bg-primary me-2 mb-2">Original</span>
              {{- end }}
              {{- if .Novel.Genre != "0" }}
              <span class="badge bg-secondary me-2 mb-2">{{ novelGenre: .Novel.Genre }}</span>
              {{- end }}
              {{- range .Novel.Tags.Tags }}
                {{- if isEmphasize(.Name) }}
                {* Intentionally empty to not render anything to avoid duplication *}
                {{- else }}
                <span class="badge fw-normal text-muted me-2 mb-2 p-0 text-wrap text-break text-start">
                  <a href="/tags/{{ escapeString(.Name) }}" class="text-decoration-none text-wrap text-break">#{{ .Name }}</a>
                </span>
                {{- end }}
              {{- end }}
            </div>

            <!-- Metadata -->
            <div class="d-flex flex-wrap text-body-secondary small mt-auto me-2">
              <div class="me-3 mb-2 mb-lg-0">
                <i class="bi bi-eye me-1"></i>
                <span>{{- .Novel.Views }}</span>
              </div>
              <div class="me-3 mb-2 mb-lg-0">
                <i class="bi bi-heart-fill me-1"></i>
                <span>{{- .Novel.Bookmarks }}</span>
              </div>
              <div class="me-3 mb-2 mb-lg-0">
                <i class="bi bi-hand-thumbs-up-fill me-1"></i>
                <span>{{- .Novel.Likes }}</span>
              </div>
              <div>
                <i class="bi bi-calendar me-1"></i>
                <span>{{- parseTime: .Novel.CreateDate }}</span>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  {{- if .Novel.SeriesNavData }}
  <div class="col-12 col-md-9">
    <div class="custom-card">
      <div class="card-body bg-charcoal-surface1 rounded-5 p-4">
        <h3 class="mb-3">Series</h3>
        <div class="list-group">
          {{- range i,v := .NovelSeriesContentTitles }}
            {{- if v.ID == .Novel.ID  }}
            <span class="list-group-item bg-charcoal-surface2 text-light">#{{ i + 1 }} {{ v.Title }}</span>
            {{- else }}
            <a href="/novel/{{ v.ID }}" class="list-group-item bg-charcoal-surface1 text-light">#{{ i + 1 }} {{ v.Title }}</a>
            {{- end }}
          {{- end }}
        </div>
      </div>
    </div>
  </div>
  {{- end }}

  <div class="col-12 col-md-9">
    <div class="custom-card">
      <div class="custom-card-body bg-charcoal-surface1 p-4">
        <h3 class="mb-3">Settings</h3>
        <div class="d-flex justify-content-start align-items-center">
          <div class="dropdown me-3">
            <button class="custom-btn-secondary bg-charcoal-surface2 dropdown-toggle" type="button" id="fontTypeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-fonts me-2"></i>Font Type
            </button>
            <ul class="dropdown-menu" aria-labelledby="fontTypeDropdown">
              <li><a class="dropdown-item" href="/settings/novelFontType?font-type=gothic">Gothic</a></li>
              <li><a class="dropdown-item" href="/settings/novelFontType?font-type=mincho">Mincho</a></li>
            </ul>
          </div>
          <div class="dropdown me-3">
            <button class="custom-btn-secondary bg-charcoal-surface2 dropdown-toggle" type="button" id="fontSizeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-text-size me-2"></i>Font Size
            </button>
            <ul class="dropdown-menu" aria-labelledby="fontSizeDropdown">
              <li><a class="dropdown-item" href="#">Small</a></li>
              <li><a class="dropdown-item" href="#">Medium</a></li>
              <li><a class="dropdown-item" href="#">Large</a></li>
            </ul>
          </div>
          <div class="dropdown">
            <button class="custom-btn-secondary bg-charcoal-surface2 dropdown-toggle" type="button" id="viewModeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-layout-text-window-reverse me-2"></i>View Mode
            </button>
            <ul class="dropdown-menu" aria-labelledby="viewModeDropdown">
              <li><a class="dropdown-item" href="/settings/novelViewMode?view-mode=1">Horizontal</a></li>
              <li><a class="dropdown-item" href="/settings/novelViewMode?view-mode=2">Vertical</a></li>
              <li><a class="dropdown-item" href="/settings/novelViewMode?view-mode=">Don't force</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-9">
    <div class="custom-card">
      <div class="card-body bg-charcoal-surface1 rounded-5 p-4">
        <div id="content" data-font="{{ .FontType }}" data-lang="{{ .Language }}" data-view="{{ .ViewMode }}">
          {{- raw: renderNovel(.Novel.Content) }}
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-md-9">
    {{- if .Novel.SeriesNavData }}
    <div class="custom-card">
      <div class="card-body bg-charcoal-surface1 rounded-5 p-4">
        <h3 class="mb-3">Series Navigation</h3>
        <p>Series: <a href="/novel/series/{{ .Novel.SeriesNavData.SeriesID }}" class="text-decoration-none">{{ .Novel.SeriesNavData.Title }}</a></p>
        {{- if .Novel.SeriesNavData.Next }}
        <p>Next: <a href="/novel/{{.Novel.SeriesNavData.Next.ID}}" class="text-decoration-none">#{{- .Novel.SeriesNavData.Next.Order }} {{ .Novel.SeriesNavData.Next.Title }}</a></p>
        {{- end}}
        {{- if .Novel.SeriesNavData.Prev }}
        <p>Prev: <a href="/novel/{{.Novel.SeriesNavData.Prev.ID}}" class="text-decoration-none">#{{- .Novel.SeriesNavData.Prev.Order }} {{ .Novel.SeriesNavData.Prev.Title }}</a></p>
        {{- end}}
      </div>
    </div>
    {{- end}}
  </div>

  <div class="col-12 col-md-9">
    <div class="custom-card">
      <div class="card-body bg-charcoal-surface1 rounded-5 p-4">
        <div class="d-flex align-items-center">
          <a href="/users/{{ .User.ID }}" class="me-3">
            <img src="{{ .User.Avatar }}" alt="{{ .User.Name }}" class="rounded-circle" style="width: 64px; height: 64px;" />
          </a>
          <div>
            <h3 class="mb-0"><a href="/users/{{ .User.ID }}" class="text-decoration-none">{{ .User.Name }}</a></h3>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-9">
    <div class="custom-card">
      <div class="custom-card-body bg-charcoal-surface1 p-4 pb-0">
        <!-- TODO: clean this logic up -->
        {{- if .Novel.CommentOff == 1 || .Novel.CommentCount == 0 }}
        <h2>0 Comments</h2>
        {{- else if .Novel.CommentCount == 1 }}
        <h2>1 Comment</h2>
        {{- else }}
        <h2>{{ .Novel.CommentCount }} Comments</h2>
        {{- end }}
        <!-- NOTE: pb-0 otherwise the last comment will add extra spacing at the end of the card -->
        {{- if .Novel.CommentOff == 1  }}
        <p class="mb-4">The creator turned comments off</p>
        {{- else if .Novel.CommentCount == 1 }}
        <p class="mb-4">There are no comments yet</p>
        {{- else }}
        <div class="list-group" id="comments-container">
          {{ range .Novel.CommentsList }}
          <!-- Element for a single comment -->
          <div class="list-group-item border-0 bg-charcoal-surface1 p-0 mb-4 comment-item">
            <div class="row">
              <!-- Comment author avatar image -->
              <div class="col-auto">
                <a href="/users/{{ .AuthorID }}">
                  <img class="img-fluid rounded-circle object-fit-cover" src="{{ .Avatar }}" alt="{{ .AuthorName }}" style="width: 40px; height: 40px" />
                </a>
              </div>

              <div class="col">
                <!-- Comment author name and date -->
                <div class="d-md-flex align-items-center mb-2">
                  <div class="me-md-2">
                    <a href="/users/{{ .AuthorID }}" class="text-body text-decoration-none">
                      <h6 class="mb-0">{{- .AuthorName }}</h6>
                    </a>
                  </div>
                  <div>
                    <small class="text-muted">{{ .Date }}</small>
                  </div>
                </div>

                <!-- Stamp or emoji -->
                <!-- TODO: .Stamp occasionally templates in text (which should be part of the main comment text) instead of an image, causing breakage in the layout. See the comment by "Unknown417" on /artworks/107442519 for an example -->
                {{- if .Stamp }}
                <img class="img-fluid rounded object-fit-cover me-2" src="/proxy/s.pximg.net/common/images/stamp/generated-stamps/{{ .Stamp }}_s.jpg" alt="/proxy/s.pximg.net/common/images/stamp/generated-stamps/{{ .Stamp }}_s.jpg" style="width: 96px; height: 96px" />
                {{- else }}
                <!-- Comment with emojis -->
                <p class="m-0">{{ raw: parseEmojis(.Context) }}</p>
                {{ end }}
              </div>
            </div>
          </div>
          {{- end }}
          <div class="d-flex justify-content-center">
            <!-- TODO: figure out how to hide the parent div instead of applying mb-4 to the button itself -->
            <button type="button" class="custom-btn-secondary-flex bg-charcoal-surface2 mb-4" id="load-more-btn">Load more</button>
          </div>
        </div>
        {{ end }}
      </div>
    </div>
  </div>

  <div class="col-12">
    <h2>Related works</h2>
    <div class="row row-cols-1 row-cols-lg-2 g-4">
      {{- range .NovelRelated }}
        {{- include "fragments/novel-tn" . }}
      {{- end }}
    </div>
  </div>
</div>
{{- end }}
